# DVD Rental Database Project

## Introduction
This project involves the analysis of a DVD rental database using PostgreSQL and Python. The goal is to uncover insights and demonstrate advanced SQL query techniques. The database schema consists of 15 interconnected tables representing various aspects of the DVD rental business.

## Steps Performed

### 1. Data Import
The data for this project was provided as CSV files. A Python script was used to automate the import process into PostgreSQL. Below is the Python script utilized:

```python
import pandas as pd
import psycopg2
import os

# Database connection details
conn_string = "host='localhost' dbname='DVDrental' user='postgre_sql' password='123456'"

# Folder location where files are stored
folder_path = r"C:/Users/avinashv/Downloads/archive"

# CSV files with corresponding table names
file_table_mapping = {
    "rental.csv": "rental",
    "staff.csv": "staff",
    "store.csv": "store",
    "film.csv": "film",
    "film_actor.csv": "film_actor",
    "film_category.csv": "film_category",
    "inventory.csv": "inventory",
    "language.csv": "language",
    "payment.csv": "payment",
    "actor.csv": "actor",
    "address.csv": "address",
    "category.csv": "category",
    "city.csv": "city",
    "country.csv": "country",
    "customer.csv": "customer"
}

# Connect to PostgreSQL
try:
    conn = psycopg2.connect(conn_string)
    cur = conn.cursor()
    print("Database connection established.")
except Exception as e:
    print("Error connecting to database:", e)
    exit()

# Function to create table dynamically
def create_table_if_not_exists(table_name, df):
    try:
        columns = ', '.join([f'"{col}" TEXT' for col in df.columns])
        create_query = f'CREATE TABLE IF NOT EXISTS "{table_name}" ({columns});'
        cur.execute(create_query)
        print(f"Table '{table_name}' created or already exists.")
    except Exception as e:
        print(f"Error creating table {table_name}:", e)

# Function to import CSV into PostgreSQL
def import_csv_to_postgres(file_path, table_name):
    try:
        # Read CSV file into a pandas DataFrame
        df = pd.read_csv(file_path, low_memory=False)

        # Create table if it doesn't exist
        create_table_if_not_exists(table_name, df)

        # Replace NaN values with None for SQL compatibility
        df = df.where(pd.notnull(df), None)

        # Generate column names dynamically
        columns = ', '.join([f'"{col}"' for col in df.columns])
        values_placeholder = ', '.join(['%s'] * len(df.columns))

        # Prepare SQL query for inserting data
        insert_query = f'INSERT INTO "{table_name}" ({columns}) VALUES ({values_placeholder})'

        # Insert rows in bulk
        for row in df.itertuples(index=False):
            cur.execute(insert_query, row)

        # Commit after processing
        conn.commit()
        print(f"Data from {file_path} inserted into {table_name} table successfully.")
    except Exception as e:
        print(f"Error importing {file_path} into {table_name}:", e)

# Iterate through all CSV files and import them into PostgreSQL
for file_name, table_name in file_table_mapping.items():
    file_path = os.path.join(folder_path, file_name)
    if os.path.exists(file_path):
        print(f"Importing {file_name} into {table_name}...")
        import_csv_to_postgres(file_path, table_name)
    else:
        print(f"File {file_path} not found. Skipping...")

# Close connections
cur.close()
conn.close()
print("All files imported successfully, database connection closed.")
```

### Key Points:
- **Database Setup:** Connected to PostgreSQL using the `psycopg2` library.
- **Dynamic Table Creation:** Automatically created tables in PostgreSQL based on the structure of each CSV file.
- **Bulk Data Insertion:** Inserted data into the corresponding tables after handling null values.

## Schema
![Schema](https://github.com/user-attachments/assets/1965958e-7aa2-483a-a20b-54171346ef7e)


## Key Questions Answered

1. **What is the total revenue generated by all rentals?**
```sql
SELECT
	SUM(AMOUNT::NUMERIC) AS TOTAL_REVENUE
FROM
	PAYMENT;
```

2. **Which category of films generates the most revenue?**
```sql
SELECT
	C.NAME AS CATEGORY,
	SUM(P.AMOUNT::NUMERIC) AS TOTAL_REVENUE
FROM
	PAYMENT P
	JOIN RENTAL R ON P.RENTAL_ID = R.RENTAL_ID
	JOIN INVENTORY I ON R.INVENTORY_ID = I.INVENTORY_ID
	JOIN FILM_CATEGORY FC ON I.FILM_ID = FC.FILM_ID
	JOIN CATEGORY C ON FC.CATEGORY_ID = C.CATEGORY_ID
GROUP BY
	C.NAME
ORDER BY
	TOTAL_REVENUE DESC;
```

3. **What is the average rental duration for all films?**
```sql
SELECT
	TO_CHAR(AVG(RENTAL_DURATION::NUMERIC), '999.00') AS AVERAGE_RENTAL_DURATION
FROM
	FILM;
```

4. **Which city has the most customers?**
```sql
SELECT
	CI.CITY,
	COUNT(C.CUSTOMER_ID) AS CUSTOMER_COUNT
FROM
	CUSTOMER C
	JOIN ADDRESS A ON C.ADDRESS_ID = A.ADDRESS_ID
	JOIN CITY CI ON A.CITY_ID = CI.CITY_ID
GROUP BY
	CI.CITY
ORDER BY
	CUSTOMER_COUNT DESC;
```

5. **How many rentals does each film have?**
```sql
SELECT
	F.TITLE,
	COUNT(R.RENTAL_ID) AS RENTAL_COUNT
FROM
	RENTAL R
	JOIN INVENTORY I ON R.INVENTORY_ID = I.INVENTORY_ID
	JOIN FILM F ON I.FILM_ID = F.FILM_ID
GROUP BY
	F.TITLE
ORDER BY
	RENTAL_COUNT DESC;
```

6. **Which staff member processes the most payments?**
```sql
SELECT
	S.FIRST_NAME || ' ' || S.LAST_NAME AS STAFF_NAME,
	COUNT(P.PAYMENT_ID) AS PAYMENT_COUNT
FROM
	PAYMENT P
	JOIN STAFF S ON P.STAFF_ID = S.STAFF_ID
GROUP BY
	STAFF_NAME
ORDER BY
	PAYMENT_COUNT DESC;
```

7. **What is the distribution of customers across countries?**
```sql
SELECT
	CO.COUNTRY,
	COUNT(C.CUSTOMER_ID) AS CUSTOMER_COUNT
FROM
	CUSTOMER C
	JOIN ADDRESS A ON C.ADDRESS_ID = A.ADDRESS_ID
	JOIN CITY CI ON A.CITY_ID = CI.CITY_ID
	JOIN COUNTRY CO ON CI.COUNTRY_ID = CO.COUNTRY_ID
GROUP BY
	CO.COUNTRY
ORDER BY
	CUSTOMER_COUNT DESC;
```

8. **What is the average payment amount for rentals?**
```sql
SELECT
	TO_CHAR(AVG(AMOUNT::NUMERIC), '999.00') AS AVERAGE_PAYMENT
FROM
	PAYMENT;
```

9. **Which film has the longest rental duration?**
```sql
SELECT
	TITLE,
	RENTAL_DURATION
FROM
	FILM
ORDER BY
	RENTAL_DURATION DESC
LIMIT
	1;
```

10. **How many active customers are there?**
```sql
SELECT COUNT(*) AS active_customers
 FROM customer
WHERE active = 1;
```

11. **What is the total revenue generated by each store?**
```sql
SELECT
	S.STORE_ID,
	SUM(P.AMOUNT::NUMERIC) AS TOTAL_REVENUE
FROM
	PAYMENT P
	JOIN RENTAL R ON P.RENTAL_ID = R.RENTAL_ID
	JOIN INVENTORY I ON R.INVENTORY_ID = I.INVENTORY_ID
	JOIN STORE S ON I.STORE_ID = S.STORE_ID
GROUP BY
	S.STORE_ID;
```

12. **Which film has the highest replacement cost?**
```sql
SELECT
	TITLE,
	REPLACEMENT_COST
FROM
	FILM
ORDER BY
	REPLACEMENT_COST DESC
LIMIT
	1;
```


## Tools Used

- **Database**: PostgreSQL
- **Language**: SQL, Python

## Linkedin
www.linkedin.com/in/avinashvasisht


---
Feel free to contribute or share feedback on this analysis!


